include('auto');

function init() {
	if(getTurn()==1) {
		Map.init()
		Items.init()
	}
	Fight.init()
	MapDanger.init()
}
init() 


if(getWeapon(Fight.self)==null) setWeapon(Items.getItem(WEAPON_PISTOL));
var enemy = Fight.getEntity(getNearestEnemy());

// debug qui affiche les cases safe en vert et avec du danger en rouge.
var arrayDanger = []
for(var c : var d in Fight.self.reachableCells) {
	var danger = MapDanger.getCellDanger(c)
	if(danger.dmg > 0) { 
		mark(c.id, getColor(danger.dmg, 0, 0))
		markText(c.id, round(danger.dmg))
		arrayDanger[round(danger.dmg)] = danger
	}
	else {
		mark(c.id, COLOR_GREEN)
	}
}
for(var danger in arrayDanger){
	debug(danger)
}

var combo = MapDanger.getPotentialCombo(Fight.self, enemy.cell)
if(count(combo.actions)>0) combo.play()
else {
	var cellToUsePistol = getCellToUseWeapon(WEAPON_PISTOL, enemy.id)
	var path = getPath(getCell(), cellToUsePistol)
	if(count(path)>getMP()){ // avance prudente
		for(var cell in path){
			var danger = MapDanger.getCellDanger(Map.getCell(cell))
			if(danger.dmg == 0) moveTowardCell(cell)
		}
	} else { // je peux tirer sur l'adv: gogo
		debugE('SHOULD NOT BE HERE !')
		moveTowardCell(cellToUsePistol)
		while(useWeapon(enemy) > 0);
	}
}

if(getMP()>0){ // on se cache si possible !
	Fight.self.refresh()
	var safeCell = null, tmpDanger = 9999999
	for(var cell:var mp in Fight.self.reachableCells){
		var danger = MapDanger.getCellDanger(cell)
		if(tmpDanger > danger.dmg) {
			safeCell = cell
			tmpDanger = danger.dmg
		}
	}
	moveTowardCell(safeCell)
}